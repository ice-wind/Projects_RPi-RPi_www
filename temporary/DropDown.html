<HTML>
	<HEAD>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">
		<title>Dropdown test</title>
		<link rel="stylesheet" type="text/css" href="css/search_style.css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		
		<script>
		var elementSearchBoxValue ;
		
		$(document).ready(function () {
			$('body').on('click','*',function(){
				$("#livesearch").slideUp();
			});
			
			$("form").submit(function(e){
				e.preventDefault();
			});
			/*
			$("body").on("change",".search",function(){
				var city_name = $(".search").val();
				var city_id = $(".city").val(city_name);
				var city_id = $(city_id[0].outerHTML)[0].getAttribute("data-ID");
				console.log(" id: "+city_id+" city :"+city_name);
				//$("#livesearch").slideUp("fast",getForecastData(city_id,city_name));
			});
			*/
			
			
			
			
		});
		
		function handle(e){
				if(e.which === 13){
					//e.preventDefault();									//--------------------important!!!
					var city_name = $(".search").val();
					if($(".city")[0]){
						var city_id = $(".city").val(city_name);
						var city_id = $(city_id[0].outerHTML)[0].getAttribute("data-ID");
						$("#livesearch").slideUp("fast",getForecastData(city_id,city_name));
					}
				}else 
					if(e.which == 8){
						$(".search").val("");
				}else{
					showResult();
				}
			}

			function passCityData(object){
				var city_id = object.getAttribute("data-ID");
				var city_name = object.innerHTML;
				$(".search").val(city_name);
				$("#livesearch").slideUp("fast",getForecastData(city_id,city_name));
			}
			
			function getForecastData(city_id,city_name){
				$.ajax({
					type: 	"GET",
					url:	"php/getDBdata_5Day.php",
					dataType: "json",
					data:	{city_id:city_id},
					success:function(response){
					
						console.log("before fade ");
						$(".result").fadeOut("fast",function(){
						console.log("inside fade ");
						console.log(response+"sdv");
						$(".result").fadeIn("fast",function(){
						
							$(".result").html("");
								$.each(response,function(i,value){
									$(".result").append("<div>Temperature : "+value.Temperature+"</div>");
								console.log(value.Temperature);
								});
						});
						});
						
					},
					error: function(jqXHR, exception) {
						console.log(jqXHR);
						if (jqXHR.status === 0) {
							alert('Not connect.\n Verify Network.');
						} else if (jqXHR.status == 404) {
							alert('Requested page not found. [404]');
						} else if (jqXHR.status == 500) {
							alert('Internal Server Error [500].');
						} else if (exception === 'parsererror') {
							alert('Requested JSON parse failed.');
						} else if (exception === 'timeout') {
							alert('Time out error.');
						} else if (exception === 'abort') {
							alert('Ajax request aborted.');
						} else {
							alert('Uncaught Error.\n' + jqXHR.responseText);
						}
					  
					},
					stop:function(){
						alert("Stop");
					}
					
				});
				return false;
			}
			
			function showResult(){
				var cityList="";
				var wrapper_cityList;
				var firstCity="";
				var searchBox = document.getElementsByClassName("search")[0];
				
				var str = $(".search").val();
				console.log(str);
				if(str!=null){
					$.ajax({
						type: 	"GET",
						url:	"php/livesearch.php",
						data: 	{search_string:str},
						success:function(response){
							if(response!=null){
								response=JSON.parse(response);
								$.each(response,function(i,data){
									if(i==0){firstCity=data.NAME}
									cityList+='<div class="city" onclick="passCityData(this)" data-ID="'+data.ID+'";>'+data.NAME+'</div>'
								});
								
								var suggestion =firstCity;
								console.log(suggestion);
								searchBox.value = suggestion;
								
								searchBox.setSelectionRange(str.length,suggestion.length);
								searchBox.focus();
							}
							wrapper_cityList='<div class="wrapper_cityList">'+cityList+'</div>';
							$("#livesearch").slideDown();
							$("#livesearch").html(wrapper_cityList);
						},
						send:	function(event,xhr,option){
							$("#livesearch").slideDown();
							$("#livesearch").append("<img src='img/loading.gif'>");
						},
						error:  function(event,xhr,options,exception){
							console.log("xhr: "+xhr+"  options: "+options+"  Exception: "+exception);
							alert(xhr);
						}
					});
				}
				return false;
			}
			 
		</script>
	</HEAD>
	<BODY>
		<div class="base_class">
			<form autocomplete="on" id="search">
				<input class="search" type="search" size="30"  onkeyup="handle(event);" data-search="" autofocus placeholder="Search..." >
				<div id="livesearch"></div>
				<div class="result"></div>
			</form>
		</div>
	</BODY>
</HTML>